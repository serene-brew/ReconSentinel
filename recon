#!/usr/bin/env bash
set -euo pipefail

# --- resolve script path even when called via symlink ---
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  TARGET="$(readlink "$SOURCE")"
  if [[ "$TARGET" == /* ]]; then
    SOURCE="$TARGET"
  else
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$DIR/$TARGET"
  fi
done
PROJECT_ROOT="$(cd -P "$(dirname "$SOURCE")" && pwd)"
cd "$PROJECT_ROOT"

VENV_DIR="${VENV:-.venv}"
PYBIN="$VENV_DIR/bin/python"

ensure_venv() {
  if [[ ! -d "$VENV_DIR" || ! -x "$PYBIN" ]]; then
    echo "‚Ñπ No usable venv found at '$VENV_DIR'. Bootstrapping‚Ä¶"
    if [[ ! -x "./setup_venv.sh" ]]; then
      echo "‚ùå Missing ./setup_venv.sh in $PROJECT_ROOT."
      echo "   Run: python3 -m venv .venv && . .venv/bin/activate && pip install -r requirements.txt"
      exit 1
    fi
    bash ./setup_venv.sh
  fi
}

activate_venv() {
  # shellcheck disable=SC1090
  source "$VENV_DIR/bin/activate"
}

check_and_install_tinyxml2() {
  # Check if libtinyxml2 libraries exist in /usr/lib and copy if missing
  local libs_dir="$PROJECT_ROOT/recon_sentinel/libs"
  local usr_lib="/usr/lib"
  local missing_libs=()
  
  # Check which libraries are missing
  if [[ ! -f "$usr_lib/libtinyxml2.so" ]]; then
    missing_libs+=("libtinyxml2.so")
  fi
  if [[ ! -f "$usr_lib/libtinyxml2.so.11" ]]; then
    missing_libs+=("libtinyxml2.so.11")
  fi
  if [[ ! -f "$usr_lib/libtinyxml2.so.11.0.0" ]]; then
    missing_libs+=("libtinyxml2.so.11.0.0")
  fi
  
  # If any libraries are missing, copy them
  if [[ ${#missing_libs[@]} -gt 0 ]]; then
    echo "‚Ñπ Some libtinyxml2 libraries are missing in $usr_lib"
    echo "  Missing: ${missing_libs[*]}"
    
    # Check if source files exist
    local all_exist=true
    for lib in "${missing_libs[@]}"; do
      if [[ ! -f "$libs_dir/$lib" ]]; then
        echo "Warning: $lib not found in $libs_dir, skipping..."
        all_exist=false
      fi
    done
    
    if [[ "$all_exist" == true ]]; then
      echo "  Copying libraries to $usr_lib (requires sudo)..."
      local copy_success=true
      for lib in "${missing_libs[@]}"; do
        if sudo cp "$libs_dir/$lib" "$usr_lib/" 2>/dev/null; then
          echo "  Copied $lib"
        else
          echo "  Failed to copy $lib (may need sudo permissions)"
          copy_success=false
        fi
      done
      
      if [[ "$copy_success" == true ]]; then
        # Update library cache if ldconfig exists
        if command -v ldconfig >/dev/null 2>&1; then
          echo "  Updating library cache..."
          sudo ldconfig 2>/dev/null || true
        fi
        echo "  libtinyxml2 libraries installed"
      else
        echo "  Some libraries could not be copied (continuing anyway...)"
      fi
    else
      echo "  Some libraries could not be copied (continuing anyway...)"
    fi
  fi
}

doctor() {
  echo "üîé ReconSentinel doctor"
  command -v python3 >/dev/null || { echo "‚ùå python3 not found"; exit 1; }
  ensure_venv
  activate_venv
  python - <<'PY'
mods = ["typer","rich","jinja2","yaml","requests","dns","markdown"]
missing = []
for m in mods:
    try:
        __import__(m)
    except Exception:
        missing.append(m)
import sys
print("Python:", sys.version.split()[0])
print("Venv OK:", "yes")
print("Missing modules:", ", ".join(missing) if missing else "none")
PY
}

main() {
  if [[ "${1:-}" == "doctor" ]]; then
    doctor
    exit 0
  fi

  # Check and install libtinyxml2 if needed
  check_and_install_tinyxml2

  ensure_venv
  activate_venv
  exec "$PYBIN" -m recon_sentinel.cli "$@"
}

main "$@"

